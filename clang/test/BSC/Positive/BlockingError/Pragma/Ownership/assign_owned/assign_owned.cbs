// RUN: %clang -rewrite-bsc %s -o %t-rw.c
// RUN: FileCheck --input-file=%t-rw.c %s
// expected-no-diagnostics

safe T *owned safe_malloc<T>(T t);
safe void test1(void) {
    #pragma GCC diagnostic push
    #pragma GCC diagnostic ignored "-Eassign-owned"
    int *owned _Nullable p = nullptr;
    int cond = 1;
    if (cond) {
        p = safe_malloc<int>(10);
        *p = 10;
    }
    p = nullptr; //assign to owned value: `p`
    #pragma GCC diagnostic pop
}

// CHECK:      static int * safe_malloc_int(int t);
// CHECK-EMPTY: 
// CHECK:      void test1(void) {
// CHECK-NEXT:     int * p = 0;
// CHECK-NEXT:     int cond = 1;
// CHECK-NEXT:     if (cond) {
// CHECK-NEXT:         p = safe_malloc_int(10);
// CHECK-NEXT:         *p = 10;
// CHECK-NEXT:     }
// CHECK-NEXT:     p = 0;
// CHECK-NEXT: }
