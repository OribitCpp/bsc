// RUN: %clang -rewrite-bsc %s -o %t-rw.c
// RUN: FileCheck --input-file=%t-rw.c %s
// expected-no-diagnostics

void use_mut(int *borrow p);
void free_owned<T>(T* owned p);
void test1(int* owned oriPtr) {
  int *borrow p = &mut *oriPtr;
  #pragma GCC diagnostic push
  #pragma GCC diagnostic ignored "-Emove-borrowed"
  free_owned<int>(oriPtr); // cannot move out of `oriPtr` because it is borrowed
  #pragma GCC diagnostic pop
  use_mut(p);
}

// CHECK:      static void free_owned_int(int * p);
// CHECK-EMPTY: 
// CHECK:      void use_mut(int * p);
// CHECK-EMPTY: 
// CHECK:      void test1(int * oriPtr) {
// CHECK-NEXT:     int * p = &*oriPtr;
// CHECK-NEXT:     free_owned_int(oriPtr);
// CHECK-NEXT:     use_mut(p);
// CHECK-NEXT: }
