// RUN: %clang -Eno-cast-nullable -rewrite-bsc %s -o %t-rw.c
// RUN: FileCheck --input-file=%t-rw.c %s
// expected-no-diagnostics

safe T *owned safe_malloc<T>(T t);
safe void safe_free(void *owned p);

safe void test1(void) {
    int *owned _Nullable p = nullptr;
    int cond = 1;
    if (cond) {
        p = safe_malloc<int>(10);
        *p = 10;
    }
    safe_free((void *owned)p);      // cannot cast nullable pointer to nonnull type
}

// CHECK:      static int * safe_malloc_int(int t);
// CHECK-EMPTY: 
// CHECK:      void safe_free(void * p);
// CHECK-EMPTY: 
// CHECK:      void test1(void) {
// CHECK-NEXT:     int * p = 0;
// CHECK-NEXT:     int cond = 1;
// CHECK-NEXT:     if (cond) {
// CHECK-NEXT:         p = safe_malloc_int(10);
// CHECK-NEXT:         *p = 10;
// CHECK-NEXT:     }
// CHECK-NEXT:     safe_free((void *)p);
// CHECK-NEXT: }
// CHECK-EMPTY: 